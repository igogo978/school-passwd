<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>public audio</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="/passwd/public/css/style.css"/>

    <script src="/passwd/public/js/vue.js"></script>
    <script src="/passwd/public/js/axios.min.js"></script>
</head>

<body>
<div id="app" class="container">

    <h4>大德國小校園廣播放送中</h4>
    <hr>
    <div class="d-flex flex-row justify-content-end p-2 bd-highlight">
        <select v-model="selected" @change="updatePage">
            <option v-for="weekday in weekdays" v-bind:value="weekday" class="form-select">
                {{weekday}}
            </option>
        </select>
    </div>
    <div class="d-flex flex-row justify-content-end p-2 bd-highlight">
    </div>
    <div v-if="displayItems.length > 0" class="row">
        <div class="col-lg-4 col-md-6 col-sm-12" v-for="item in displayItems">
            <div v-if="item.type == 'audio'" class="card shadow-sm">
                <audio controls preload="none">
                  <source v-bind:src="item['prefix']+item['content']"
                            type="audio/mpeg"/>
                </audio>


                    <div class="card-body">
                        <p class="card-text">{{item.username}} - {{item.description}} </p>
                        <div class="input-group mb-3">
                            <button class="btn btn-outline-secondary" type="button" disabled>宣導期限</button>
                            <input v-model="new Date(item.expired*1000).toLocaleString('zh-TW',{timezone: 'Asia/Taipei'})"
                                   type="text" class="form-control" placeholder="item expired"
                                   aria-label="item expired" aria-describedby="button-addon2" readonly>


                        </div>
                        <div class="input-group mb-3">


                            <ul class="list-group">
                                <li v-for="(value,name,index) in item.playtime" class="list-group-item">
                                    {{name}}-{{value}}
                                </li>
                            </div>

                        <div class="d-flex justify-content-end flex-row">

                            <button v-if="user.roles.includes('admin')" v-on:click="disable(item)" type="button"
                                    class="btn btn-sm btn-outline-danger">
                                失效
                            </button>
                        </div>

                    </div>
            </div>
        </div>
    </div>


</div>

<footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <script th:inline="javascript">
      /*<![CDATA[*/

      Vue.prototype.$http = axios;
      let config = {
        headers: {
          'content-type': 'application/json;CHARSET=UTF-8'
        }
      };


      var app = new Vue({
        el: '#app',
        data: {
          user: /*[[${user}]]*/ {},
          useritemcount: /*[[${useritemcount}]]*/ {},
          items: /*[[${items}]]*/ [],
          audioitems: [],
          weekdays: ["all","1Mon","2Tue","3Wed","4Thu","5Fri"],
          selected: "all",
          displayItems: [],
        },
        created: function () {
          let vm = this;
          this.displayItems = this.items;
        },
        computed: {
            getAudio: function(){
                if(this.items.length !=0) {
                    console.log("update audio files");
                    this.items.forEach(item=>{
                        let url = "/passwd/api/useraudioitem/id/"+item.id ;
                        let vm=this;
                        this.$http.get(url, config)
                             .then(function (response) {
                                 let item = response.data;
                                 vm.audioitems.push(item);
                             })
                             .catch(function (error) {
                               /* 失敗，發生錯誤，然後...*/
                          });

                    });
                }
            }
        },
        methods: {
          switchpage: function(page) {
            this.page = page;
          },
           updatePage: function() {
            if (this.selected == "all") {
                this.displayItems = this.items ;
            } else {
                console.log("filter weekday: " + this.selected);
                this.displayItems = this.filterWeekday();
            }
          },
          filterWeekday: function() {
            filteredItems = [];
            this.items.forEach(item=>{
                Object.keys(item.playtime).forEach(key =>{
                    if (key == this.selected) {
                        filteredItems.push(item);
                    };
                });
            });
            return filteredItems;
          },
        }
      })

      /*]]>*/







    </script>
</footer>

</body>

</html>